<!DOCTYPE html> 
<html>
<head>
	<link type="text/css" rel="stylesheet" href="video-js.css"/>
	<link href="videojs\videojs-overlay\dist\videojs-overlay.css" rel="stylesheet">
	<style>
		div.overlay {
			font-size: 500%;
		}
	</style>
</head>
<body>
<center>
<br>
<video
	id="vidjs"
	class="video-js vjs-default-skin"
	controls
	width="640" height="360"
	data-setup='{"sources": [{ "type": "video/mp4", "src": "vids/testmovie.mp4", "fluid": true}] }'
	>
</video>
<br>
<button id="shake" style="height:20px;width:150px;font-size:10px">Connect to photon</button>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="videojs\video.js\dist\video.js"></script>
<script src="videojs\videojs-overlay\dist\videojs-overlay.js"></script>
<script>

var actionB = document.getElementById('shake');			// Action button for testing shake input
var vid = videojs('vidjs');								// Video player object
var POSTurl = "https://api.particle.io/v1/devices/2a005e001551353531343431/";	// particle.io API url
var apiURL = "http://192.168.0.101:8081/";					// Nichin's IP

// Video objects start here - declare in reverse order so parents can reference their children
var VIDA = {
	src: "vids/a.mp4",
	type: "video/mp4",
	end: true,
	events: [[false, 2], [false, 3]],
	check: [false, 0],
	overlay: function() {
		vid.overlay({
			class: 'overlay',
			showBackground: false,
			overlays: [{
				content: 'shake',
				start: 'play',
				end: 5,
				align: 'top-left'
			}]
		});
	}
};

var VIDB = {
	src: "vids/b.mp4",
	type: "video/mp4",
	end: true,
	events: [[false, 2], [false, 3]],
	check: [false, 0],
	overlay: function() {
		vid.overlay({
			class: 'overlay',
			showBackground: false,
			overlays: [{
				content: 'noshake',
				start: 'play',
				end: 5,
				align: 'top-left'
			}]
		});
	}
};

var VIDROOT = {
	src: "vids/testmovie.mp4",
	type: "video/mp4",
	events: [[true, 2, "controlLED", "ledOn"],[true, 3, "controlLED", "ledOff"]], // [execute?, timestamp, function name, function arg]
	check: [true, 5, "checkButton", "", 0, "Help!!!"],	// [execute?, timestamp, function name, arg, result, overlay text]
	end: false,
	childA: VIDA,
	childB: VIDB
};
// Video objects end here

var thisVid = VIDROOT;

//actionB.style.visibility = 'hidden';
vid.on('timeupdate', function() {
	for (i = 0; i < thisVid.events.length; i++) {		// Loop through available events 
		if (thisVid.events[i][0] & (vid.currentTime() >= thisVid.events[i][1])) {	// Event not fired yet and time is correct
			thisVid.events[i][0] = false;				// Clear event flag
			window[thisVid.events[i][2]](thisVid.events[i][3]);			// Execute designated function(args)
		}
	}
	if ((vid.currentTime() >= thisVid.check[1]) & thisVid.check[0]) {
		thisVid.check[0] = false;
		document.querySelector('.content ,value').innerHTML = "HELP GOKU POWER UP!!!"
		window[thisVid.check[2]](thisVid.check[3]);
	}
});

vid.on('ended', function() {
	//console.log("ended event fired");
	if (!thisVid.end) {		// Not the last video in the tree
		if (thisVid.check[4] == 1) {
			console.log("Positive input received");
			document.querySelector('.content ,value').innerHTML = "GOOD JOB!!!"
			thisVid = thisVid.childA;
			changeSource({type: thisVid.type, src: thisVid.src});
		}
		else {
			console.log("Negative/no input received");
			document.querySelector('.content ,value').innerHTML = "YOU DONE GOOFED."
			thisVid = thisVid.childB;
			changeSource({type: thisVid.type, src: thisVid.src});
			VIDROOT.childB.overlay();
		}
		//actionB.style.visibility = 'visible';
		if (thisVid.check[0]) {
			vid.overlay({
				class: 'overlay',
				showBackground: false,
				overlays: [{
					content: thisVid.check[5],
					start: thisVid.check[1] - 1,
					end: thisVid.check[1] + 5,
					align: 'top-left'
				}]
			});
		}
		else {
			vid.overlay({
				class: 'overlay',
				showBackground: false,
				overlays: [{
					content: "",
					start: 'play',
					end: 'stop'
				}]
			});
		}
	}
	
	else {
	console.log("end of tree");}
});

vid.overlay({
	class: 'overlay',
	showBackground: false,
	overlays: [{
		content: thisVid.check[5],
		start: thisVid.check[1] - 1,
		end: thisVid.check[1] + 5,
		align: 'top-left'
	}]
});

function checkButton() {
	$.ajax({
        type: "POST",
			url: apiURL + "photon",
			//contentType: "text/plain",
			data: {
				func: "button",
			},
			timeout: 7000,
			success: function(data) {
				console.log("Button response: " + data);	
				if (data == 1) {
					thisVid.check[4] = 1;
				}
				else {
					thisVid.check[4] = 0;
				}
				document.querySelector('.content ,value').innerHTML = "";
			},
			error: function() {
				console.log("checkButton timed out");
				return false;
			}
		});
	//console.log("end of checkButton");
}

vid.ready(function () {
	vid.src({type: thisVid.type, src: thisVid.src});
	//vid.play();
	
});

function controlLED(cmd) {
	$.ajax({
        type: "POST",
		url: apiURL + "photon",
		data: {
			func: cmd
		},
		timeout: 7000,
		success: function(data) {
			console.log(data);	
		},
		error: function() {
			console.log("controlLED timed out");
			return false;
		}
	});
}

function connect(ipAddress) {
	$.ajax({
        type: "POST",
		url: "https://api.particle.io/v1/devices/2a005e001551353531343431/connect",
		data: {
			access_token: "371d886ca00a3722f39956df7b35b7c6c292d6d3",
			ip: ipAddress
		},
		timeout: 7000,
		success: function(data) {
			console.log("Connected to photon!");	
			console.log(data);
			actionB.style.visibility='hidden';
		},
		error: function() {
			console.log("Could not connect to photon!");
			return false;
		}
	});
}

function changeSource(sources) {
		vid.src(sources);
		vid.play();
	}
	
$("#shake").on('click', function () {
	connect("192.168.0.101");
});	
	
</script> 
<div class="content"><span class="value"></span></div>
</div>
</center>
</body>
</html>